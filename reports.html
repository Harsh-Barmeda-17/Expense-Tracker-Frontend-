<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Reports</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Deep Earthy Theme - No White */
            --bg-color: #1e1e1e;
            --card-color: #2a2a2a;
            --text-color: #e0e0e0;
            --text-secondary: #9e9e9e;
            --header-color: #d4af37;
            --primary-color: #8b5a2b;
            --primary-light: #a67c52;
            --button-color: #8b5a2b;
            --button-hover: #6d4521;
            --button-secondary: #3d3d3d;
            --button-secondary-hover: #4d4d4d;
            --income-color: #4caf50;
            --expense-color: #f44336;
            --border-color: #3d3d3d;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --chart-color-1: #8b5a2b;
            --chart-color-2: #4caf50;
            --chart-color-3: #ff9800;
            --chart-color-4: #f44336;
        }

        [data-theme="light"] {
            /* Light Earthy Alternative - Still No Pure White */
            --bg-color: #f5f5f0;
            --card-color: #e8e5da;
            --text-color: #333333;
            --text-secondary: #666666;
            --header-color: #8b5a2b;
            --primary-color: #a67c52;
            --primary-light: #c19a6b;
            --button-color: #8b5a2b;
            --button-hover: #6d4521;
            --button-secondary: #d5d5c3;
            --button-secondary-hover: #c5c5b3;
            --income-color: #388e3c;
            --expense-color: #d32f2f;
            --border-color: #c5c5b3;
            --shadow: 0 4px 12px rgba(139, 90, 43, 0.15);
            --shadow-lg: 0 8px 24px rgba(139, 90, 43, 0.2);
            --success-color: #388e3c;
            --warning-color: #f57c00;
            --danger-color: #d32f2f;
            --chart-color-1: #a67c52;
            --chart-color-2: #388e3c;
            --chart-color-3: #f57c00;
            --chart-color-4: #d32f2f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            min-height: 100vh;
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            color: var(--header-color);
            font-family: 'Quicksand', sans-serif;
            letter-spacing: 0.5px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            width: 100%;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 1.8rem;
            color: var(--header-color);
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--header-color);
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .checkbox {
            opacity: 0;
            position: absolute;
        }

        .checkbox-label {
            background-color: #111;
            width: 50px;
            height: 26px;
            border-radius: 50px;
            position: relative;
            padding: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fa-moon {color: #d4af37;}
        .fa-sun {color: #fbc02d;}

        .checkbox-label .ball {
            background-color: #fff;
            width: 22px;
            height: 22px;
            position: absolute;
            left: 2px;
            top: 2px;
            border-radius: 50%;
            transition: transform 0.2s linear;
        }

        .checkbox:checked + .checkbox-label .ball {
            transform: translateX(24px);
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background-color: var(--card-color);
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 100%;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 8px 12px;
            border-radius: 8px;
            background-color: transparent;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            flex: 1;
            min-width: 0;
            text-align: center;
            justify-content: center;
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: var(--shadow);
        }

        .nav-tab:hover:not(.active) {
            background-color: var(--button-secondary);
            color: var(--text-color);
        }

        .nav-tab i {
            font-size: 1rem;
        }

        .card {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
            width: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card h2 i {
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
            width: 100%;
        }

        .chart-container {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            width: 100%;
        }

        .chart-container h2 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container h2 i {
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
        }

        @media (max-width: 1024px) {
            .container {
                padding: 0 15px;
            }
            
            .charts {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px 0;
            }
            
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                justify-content: center;
                gap: 5px;
                padding: 6px;
            }
            
            .nav-tab {
                padding: 8px 12px;
                font-size: 0.85rem;
                flex-grow: 1;
                text-align: center;
            }
            
            .charts {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 600px) {
            .charts {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .nav-tabs {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 5px;
                padding: 6px;
            }
            
            .nav-tab {
                padding: 8px 5px;
                font-size: 0.8rem;
                white-space: nowrap;
            }
        }

        @media (max-width: 375px) {
            .nav-tabs {
                grid-template-columns: 1fr;
            }
            
            .nav-tab {
                padding: 8px 5px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-wallet logo-icon"></i>
                    <h1>Expense Tracker</h1>
                </div>
            </div>
            <div class="header-right">
                <input type="checkbox" class="checkbox" id="themeToggleCheckbox">
                <label for="themeToggleCheckbox" class="checkbox-label">
                    <i class="fas fa-moon"></i>
                    <i class="fas fa-sun"></i>
                    <span class="ball"></span>
                </label>
            </div>
        </header>

        <div class="nav-tabs">
            <a href="index.html" class="nav-tab">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="add-transaction.html" class="nav-tab">
                <i class="fas fa-plus-circle"></i> Add
            </a>
            <a href="transactions.html" class="nav-tab">
                <i class="fas fa-list"></i> Transactions
            </a>
            <a href="reports.html" class="nav-tab active">
                <i class="fas fa-chart-pie"></i> Reports
            </a>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h2><i class="fas fa-chart-pie"></i> Expense Categories</h2>
                <div class="chart-wrapper">
                    <canvas id="pieChartReports"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h2><i class="fas fa-chart-bar"></i> Monthly Summary</h2>
                <div class="chart-wrapper">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h2><i class="fas fa-chart-line"></i> Balance Over Time</h2>
                <div class="chart-wrapper">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if required elements exist
            const themeToggleCheckbox = document.getElementById('themeToggleCheckbox');
            const pieCanvas = document.getElementById('pieChartReports');
            const barCanvas = document.getElementById('barChart');
            const lineCanvas = document.getElementById('lineChart');
            
            if (!themeToggleCheckbox || !pieCanvas || !barCanvas || !lineCanvas) {
                console.error('Required elements not found in DOM');
                return;
            }

            // Initialize variables
            let pieChartReports, barChart, lineChart;
            let transactions = [];

            // Load data from localStorage
            function loadData() {
                // Load theme preference
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'light') {
                    document.documentElement.setAttribute('data-theme', 'light');
                    themeToggleCheckbox.checked = true;
                }
                
                // Load transactions
                const savedTransactions = localStorage.getItem('transactions');
                if (savedTransactions) {
                    transactions = JSON.parse(savedTransactions);
                }
            }

            // Initialize charts
            function initCharts() {
                try {
                    // Initialize Pie Chart with fixed colors
                    pieChartReports = new Chart(pieCanvas.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: [
                                    '#8b5a2b', // Brown
                                    '#4caf50', // Green
                                    '#ff9800', // Orange
                                    '#f44336', // Red
                                    '#a67c52', // Light Brown
                                    '#388e3c', // Dark Green
                                    '#f57c00', // Dark Orange
                                    '#d32f2f', // Dark Red
                                    '#c19a6b', // Tan
                                    '#689f38'  // Light Green
                                ],
                                borderColor: 'var(--card-color)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        color: 'var(--text-color)',
                                        font: {
                                            family: 'Rubik'
                                        },
                                        padding: 20,
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.raw || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = Math.round((value / total) * 100);
                                            return `${label}: ₹${value.toLocaleString()} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Initialize Bar Chart with rounded corners and semi-transparent colors
                    barChart = new Chart(barCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Income',
                                    data: [],
                                    backgroundColor: 'rgba(76, 175, 80, 0.7)', // Semi-transparent green
                                    borderColor: 'var(--income-color)',
                                    borderWidth: 1,
                                    borderRadius: 6, // Rounded corners for bars
                                    borderSkipped: false // Apply rounding to all corners
                                },
                                {
                                    label: 'Expense',
                                    data: [],
                                    backgroundColor: 'rgba(244, 67, 54, 0.7)', // Semi-transparent red
                                    borderColor: 'var(--expense-color)',
                                    borderWidth: 1,
                                    borderRadius: 6, // Rounded corners for bars
                                    borderSkipped: false // Apply rounding to all corners
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    stacked: false,
                                    grid: {
                                        color: 'var(--border-color)'
                                    },
                                    ticks: {
                                        color: 'var(--text-color)'
                                    }
                                },
                                y: {
                                    stacked: false,
                                    grid: {
                                        color: 'var(--border-color)'
                                    },
                                    ticks: {
                                        color: 'var(--text-color)',
                                        callback: function(value) {
                                            return '₹' + value;
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: 'var(--text-color)'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ₹' + context.raw.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Initialize Line Chart with theme-appropriate colors
                    lineChart = new Chart(lineCanvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Balance',
                                data: [],
                                borderColor: 'var(--primary-color)',
                                backgroundColor: 'rgba(139, 90, 43, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: 'var(--card-color)',
                                pointBorderColor: 'var(--primary-color)',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    grid: {
                                        color: 'var(--border-color)'
                                    },
                                    ticks: {
                                        color: 'var(--text-color)'
                                    }
                                },
                                y: {
                                    grid: {
                                        color: 'var(--border-color)'
                                    },
                                    ticks: {
                                        color: 'var(--text-color)',
                                        callback: function(value) {
                                            return '₹' + value;
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: 'var(--text-color)'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return 'Balance: ₹' + context.raw.toLocaleString();
                                        }
                                    }
                                }
                            },
                            elements: {
                                line: {
                                    borderJoinStyle: 'round' // Rounded line joins
                                }
                            }
                        }
                    });

                    console.log('Charts initialized successfully');
                    return true;
                } catch (error) {
                    console.error('Error initializing charts:', error);
                    return false;
                }
            }

            // Update charts with current data
            function updateCharts() {
                if (!transactions || transactions.length === 0) {
                    console.log('No transactions data available');
                    return;
                }

                try {
                    // Update pie chart
                    const expenseData = transactions
                        .filter(t => t.type === 'expense')
                        .reduce((acc, t) => {
                            acc[t.category] = (acc[t.category] || 0) + t.amount;
                            return acc;
                        }, {});
                    
                    pieChartReports.data.labels = Object.keys(expenseData);
                    pieChartReports.data.datasets[0].data = Object.values(expenseData);
                    pieChartReports.update();

                    // Update bar chart
                    const monthlyData = transactions.reduce((acc, t) => {
                        const date = new Date(t.date);
                        const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (!acc[monthYear]) acc[monthYear] = { income: 0, expense: 0 };
                        t.type === 'income' ? acc[monthYear].income += t.amount : acc[monthYear].expense += t.amount;
                        return acc;
                    }, {});

                    const sortedMonths = Object.keys(monthlyData).sort();
                    const last6Months = sortedMonths.slice(-6);

                    barChart.data.labels = last6Months.map(month => {
                        const [year, m] = month.split('-');
                        return new Date(year, m - 1).toLocaleDateString('default', { month: 'short', year: '2-digit' });
                    });
                    
                    // Update colors based on theme
                    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
                    barChart.data.datasets[0].backgroundColor = isLight ? 'rgba(56, 142, 60, 0.7)' : 'rgba(76, 175, 80, 0.7)';
                    barChart.data.datasets[1].backgroundColor = isLight ? 'rgba(211, 47, 47, 0.7)' : 'rgba(244, 67, 54, 0.7)';
                    
                    barChart.data.datasets[0].data = last6Months.map(m => monthlyData[m].income);
                    barChart.data.datasets[1].data = last6Months.map(m => monthlyData[m].expense);
                    barChart.update();

                    // Update line chart
                    const balanceData = {};
                    let balance = 0;
                    
                    [...transactions]
                        .sort((a, b) => new Date(a.date) - new Date(b.date))
                        .forEach(t => {
                            balance += t.type === 'income' ? t.amount : -t.amount;
                            balanceData[t.date] = balance;
                        });

                    const dates = Object.keys(balanceData).sort();
                    const step = Math.ceil(dates.length / 30);
                    const filteredDates = [];
                    const filteredBalances = [];
                    
                    for (let i = 0; i < dates.length; i += step) {
                        filteredDates.push(dates[i]);
                        filteredBalances.push(balanceData[dates[i]]);
                    }
                    
                    if (dates.length > 0 && filteredDates[filteredDates.length - 1] !== dates[dates.length - 1]) {
                        filteredDates.push(dates[dates.length - 1]);
                        filteredBalances.push(balanceData[dates[dates.length - 1]]);
                    }
                    
                    lineChart.data.labels = filteredDates.map(d => 
                        new Date(d).toLocaleDateString('default', { day: 'numeric', month: 'short' })
                    );
                    lineChart.data.datasets[0].data = filteredBalances;
                    
                    // Update line color based on theme
                    lineChart.data.datasets[0].borderColor = isLight ? 'var(--primary-color)' : 'var(--primary-color)';
                    lineChart.data.datasets[0].backgroundColor = isLight ? 'rgba(166, 124, 82, 0.1)' : 'rgba(139, 90, 43, 0.1)';
                    lineChart.update();

                } catch (error) {
                    console.error('Error updating charts:', error);
                }
            }

            // Set up event listeners
            function setupEventListeners() {
                try {
                    themeToggleCheckbox.addEventListener('change', () => {
                        const isLight = themeToggleCheckbox.checked;
                        
                        if (isLight) {
                            document.documentElement.setAttribute('data-theme', 'light');
                            localStorage.setItem('theme', 'light');
                        } else {
                            document.documentElement.removeAttribute('data-theme');
                            localStorage.setItem('theme', 'dark');
                        }
                        updateCharts();
                    });
                } catch (error) {
                    console.error('Error setting up event listeners:', error);
                }
            }

            // Main initialization sequence
            loadData();
            if (initCharts()) {
                updateCharts();
                setupEventListeners();
            }
        });
    </script>
</body>
</html>